{% comment %}
Create form populated by collection's product types and product tags

Accepts:
- collection: {Object} Collection Liquid object (required)

Usage:
{% render 'collection-filter', collection: collection %}
{% endcomment %}
{% assign separator = settings.filter__separator %}

{% comment %}Sanitize input to be case insensitive and strip additional spaces and remove repeats{% endcomment %}
{% assign categories = settings.filter__prefix | remove: ' ' | downcase | split: ',' | uniq %}

<aside class="collection__filter filter">
    
    <div class="filter__container">
        <h2 class="filter__title">Filter</h2>
        <div class="filter__category-container">

            {% for category in categories %}
                {% render 'filter-category', tags: collection.all_tags , category: category %}
            {% endfor %}

        </div>
    </div>

</aside>

<script>
    
    const tags = document.querySelectorAll('.category__checkbox');
    addTagListeners();

    function addTagListeners() {
        tags.forEach(tag => {
            tag.addEventListener('change', () => updateURL(tag));
        });
    }

    {% comment %}
        Takes a string representation of anchor element and returns text in href attr
        @param {String} str Stringified anchor element    
        @return {String} Text within href attribute of str
    {% endcomment %}
    function parseAnchorStr(str) {
        const regex = /\/collections(.*?)"/gm;
        let href = str.match(regex);
        href = href[0].split('"');
        return href[0];
    }

    {% comment %}
        Change url based on state of tag and update history
        @param {Npde} tag Checkbox clicked    
        @return {String} Text within href attribute of str
    {% endcomment %}
    function updateURL(tag) {
        const _tag = (tag.checked) ? tag.dataset.addTag : tag.dataset.removeTag;
        const href = parseAnchorStr(_tag);
        window.location.href = href;
    }
    
    const tagCounts = document.querySelectorAll('.category__tag-count');
    const allProducts = {{collection.all_products | json}};

    function getProductCount(el) {
        const tag = el.dataset.tag;
        const matchingProducts = allProducts.filter(product => product.tags.includes(tag));
        el.innerText = `(${matchingProducts.length})`;
    }

    tagCounts.forEach(tag => {
        getProductCount(tag)
    });

</script>